name: NPM CI

on:
  pull_request:
    branches:
      - main
    paths:
      - 'actions/role-sync'
      - 'actions/role-sync/**'
      - 'actions/discussion-cleanup'
      - 'actions/discussion-cleanup/**'
      # Ensure workflow edits also validate the pipeline
      - '.github/workflows/npm-ci.yml'
  push:
    branches:
      - main
    paths:
      - 'actions/role-sync'
      - 'actions/role-sync/**'
      - 'actions/discussion-cleanup'
      - 'actions/discussion-cleanup/**'
      # Ensure workflow edits also validate the pipeline
      - '.github/workflows/npm-ci.yml'
  workflow_dispatch:

permissions:
  contents: write
  security-events: write

env:
  ROLE_SYNC_NODE_VERSION_FILE: actions/role-sync/.node-version
  DISCUSSION_CLEANUP_NODE_VERSION_FILE: actions/discussion-cleanup/.node-version
  NPM_CONFIG_PACKAGE_LOCK: true

jobs:
  verify:
    name: Verify (${{ matrix.display_name }})
    if: github.event_name != 'schedule'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson('{"include":[{"id":"role-sync","display_name":"Role Sync","workdir":"actions/role-sync","node_version_file":"actions/role-sync/.node-version","format_script":"format:check","lint_script":"lint","test_script":"ci-test","package_script":"package","dist_path":"dist"},{"id":"discussion-cleanup","display_name":"Discussion Cleanup","workdir":"actions/discussion-cleanup","node_version_file":"actions/discussion-cleanup/.node-version","format_script":"format:check","lint_script":"","test_script":"ci-test","package_script":"package","dist_path":"dist"}]}') }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: ${{ matrix.node_version_file }}
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Install Dependencies
        run: npm ci

      - name: Format Check
        run: npm --prefix '${{ matrix.workdir }}' run ${{ matrix.format_script }}

      - name: ESLint
        if: ${{ matrix.lint_script != '' }}
        run: npm --prefix '${{ matrix.workdir }}' run ${{ matrix.lint_script }}

      - name: Run Tests
        if: ${{ matrix.test_script != '' }}
        run: npm --prefix '${{ matrix.workdir }}' run ${{ matrix.test_script }}

      - name: Bundle
        run: npm --prefix '${{ matrix.workdir }}' run ${{ matrix.package_script }}

      - name: Compare dist/
        id: diff
        run: |
          if [ ! -d "${{ matrix.workdir }}/${{ matrix.dist_path }}" ]; then
            echo "Expected ${{ matrix.dist_path }} directory does not exist.  See status below:"
            ls -la "${{ matrix.workdir }}/"
            exit 1
          fi
          if [ "$(git -C '${{ matrix.workdir }}' diff --ignore-space-at-eol --text ${{ matrix.dist_path }} | wc -l)" -gt "0" ]; then
            echo "Detected uncommitted changes after build. See status below:"
            git -C '${{ matrix.workdir }}' diff --ignore-space-at-eol --text ${{ matrix.dist_path }}
            exit 1
          fi

      - if: ${{ failure() && steps.diff.outcome == 'failure' }}
        name: Upload Artifact
        uses: actions/upload-artifact@v5
        with:
          name: ${{ matrix.id }}-dist
          path: ${{ matrix.workdir }}/dist/

  dependency-audit:
    name: Dependency Audit (${{ matrix.display_name }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson('{"include":[{"id":"role-sync","display_name":"Role Sync","workdir":"actions/role-sync","node_version_file":"actions/role-sync/.node-version","format_script":"format:check","lint_script":"lint","test_script":"ci-test","package_script":"package","dist_path":"dist"},{"id":"discussion-cleanup","display_name":"Discussion Cleanup","workdir":"actions/discussion-cleanup","node_version_file":"actions/discussion-cleanup/.node-version","format_script":"format:check","lint_script":"","test_script":"","package_script":"package","dist_path":"dist"}]}') }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: ${{ matrix.node_version_file }}
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Install Dependencies
        run: npm ci

      - name: npm audit (production, high+)
        run: npm audit --workspace ${{ matrix.workdir }} --omit=dev --audit-level=high

